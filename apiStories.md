# API Documentation for Stories and Comments

This document provides detailed information about the API endpoints for managing stories and comments in the mindbloom application. It includes endpoint descriptions, request/response formats, authentication requirements, and error handling to assist frontend developers in integrating with the backend. This version reflects updates to the API endpoints and response handling based on the modified backend code.

## Base URL

All API endpoints are relative to the base URL:  
`https://api.mindbloom.com`

## Authentication

- **JWT Tokens**: All endpoints (except fetching comments) require a JSON Web Token (JWT) for authentication, provided in the `Authorization` header as `Bearer <token>`. The token is verified using the `verifyToken` middleware, which extracts the `userId` from the decoded token.
- **Access Control**: Users can only edit or delete their own stories and comments, enforced by comparing the `userId` from the token with the `userId` stored in the story or comment.

## Data Storage

- **Elasticsearch**: Stories and comments are stored in Elasticsearch. Stories are stored in the `stories` index, and comments are stored in the `comments` index.
- **Redis**: Likes for stories are stored in Redis as sets, with keys in the format `story:<storyId>:likes`.

## Endpoints

### 1. Create a Story

Creates a new story and saves it to Elasticsearch.

- **URL**: `/stories`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **Request Body**:

  ```json
  {
    "title": "string",
    "body": "string",
    "hashtags": ["string"]
  }
  ```

  - `title`: Story title (required, min 1 character).
  - `body`: Story content (required, min 1 character).
  - `hashtags`: Array of hashtags (required, at least 1 hashtag).

- **Response**:
  - **Success (201)**:

    ```json
    {
      "message": "Story created successfully",
      "storyId": "string"
    }
    ```

  - **Error (400)**:

    ```json
    {
      "message": "All fields are required"
    }
    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to save story"
    }
    ```
- **Notes**:
  - The `storyId` is a UUID generated by the server.
  - The story is associated with the `userId` from the JWT.
  - The `createdAt` field is set to the current timestamp in ISO format.

### 2. Edit a Story

Updates an existing story in Elasticsearch.

- **URL**: `/stories/:id`
- **Method**: `PUT`
- **Content-Type**: `application/json`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **URL Parameters**:
  - `id`: Story ID (required).
- **Request Body**:

  ```json
  {
    "title": "string",
    "body": "string",
    "hashtags": ["string"]
  }
  ```

  - `title`: Updated story title (required).
  - `body`: Updated story content (required).
  - `hashtags`: Updated array of hashtags (required).

- **Response**:
  - **Success (200)**:

    ```json
    {
      "message": "Story updated successfully"
    }
    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (403)**:

    ```json
    {
      "message": "You cannot edit this story"
    }
    ```

  - **Error (404)**:

    ```json
    {
      "message": "Story not found"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to update story"
    }
    ```
- **Notes**:
  - Only the story's author (matching `userId`) can edit the story.
  - The `updatedAt` field is set to the current timestamp in ISO format.
  - The story ID remains unchanged.

### 3. Delete a Story

Deletes a story from Elasticsearch.

- **URL**: `/stories/:id`
- **Method**: `DELETE`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **URL Parameters**:
  - `id`: Story ID (required).
- **Response**:
  - **Success (200)**:

    ```json
    {
      "message": "Story deleted successfully"
    }
    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (403)**:

    ```json
    {
      "message": "You cannot delete this story"
    }
    ```

  - **Error (404)**:

    ```json
    {
      "message": "Story not found"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to delete story"
    }
    ```
- **Notes**:
  - Only the story's author (matching `userId`) can delete the story.
  - Associated likes in Redis are not automatically deleted; consider cleaning up manually if needed.

### 4. Get User's Stories

Fetches all stories created by the authenticated user.

- **URL**: `/stories/mine`
- **Method**: `GET`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **Response**:
  - **Success (200)**:

    ```json
    {
      "stories": [
        {
          "id": "string",
          "userId": "string",
          "title": "string",
          "body": "string",
          "hashtags": ["string"],
          "createdAt": "string",
          "updatedAt": "string | null"
        }
      ]
    }
    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to fetch your stories"
    }
    ```
- **Notes**:
  - Stories are sorted by `createdAt` in descending order (newest first '

System: The response was truncated due to exceeding the maximum length. Below is the complete, updated API documentation for the provided backend code, ensuring all endpoints are covered and aligned with the modifications.

# API Documentation for Stories and Comments

This document provides detailed information about the API endpoints for managing stories and comments in the mindbloom application. It includes endpoint descriptions, request/response formats, authentication requirements, and error handling to assist frontend developers in integrating with the backend. This version reflects updates to the API endpoints and response handling based on the modified backend code.

## Base URL

All API endpoints are relative to the base URL:  
`https://api.mindbloom.com`

## Authentication

- **JWT Tokens**: All endpoints (except fetching comments) require a JSON Web Token (JWT) for authentication, provided in the `Authorization` header as `Bearer <token>`. The token is verified using the `verifyToken` middleware, which extracts the `userId` from the decoded token.
- **Access Control**: Users can only edit or delete their own stories and comments, enforced by comparing the `userId` from the token with the `userId` stored in the story or comment.

## Data Storage

- **Elasticsearch**: Stories and comments are stored in Elasticsearch. Stories are stored in the `stories` index, and comments are stored in the `comments` index.
- **Redis**: Likes for stories are stored in Redis as sets, with keys in the format `story:<storyId>:likes`.

## Endpoints

### 1. Create a Story

Creates a new story and saves it to Elasticsearch.

- **URL**: `/stories`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **Request Body**:

  ```json
  {
    "title": "string",
    "body": "string",
    "hashtags": ["string"]
  }
  ```

  - `title`: Story title (required, min 1 character).
  - `body`: Story content (required, min 1 character).
  - `hashtags`: Array of hashtags (required, at least 1 hashtag).

- **Response**:
  - **Success (201)**:

    ```json
    {
      "message": "Story created successfully",
      "storyId": "string"
    }
    ```

  - **Error (400)**:

    ```json
    {
      "message": "All fields are required"
    }
    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to save story"
    }
    ```
- **Notes**:
  - The `storyId` is a UUID generated by the server.
  - The story is associated with the `userId` from the JWT.
  - The `createdAt` field is set to the current timestamp in ISO format.

### 2. Edit a Story

Updates an existing story in Elasticsearch.

- **URL**: `/stories/:id`
- **Method**: `PUT`
- **Content-Type**: `application/json`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **URL Parameters**:
  - `id`: Story ID (required).
- **Request Body**:

  ```json
  {
    "title": "string",
    "body": "string",
    "hashtags": ["string"]
  }
  ```

  - `title`: Updated story title (required).
  - `body`: Updated story content (required).
  - `hashtags`: Updated array of hashtags (required).

- **Response**:
  - **Success (200)**:

    ```json
    {
      "message": "Story updated successfully"
    }
    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (403)**:

    ```json
    {
      "message": "You cannot edit this story"
    }
    ```

  - **Error (404)**:

    ```json
    {
      "message": "Story not found"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to update story"
    }
    ```
- **Notes**:
  - Only the story's author (matching `userId`) can edit the story.
  - The `updatedAt` field is set to the current timestamp in ISO format.
  - The story ID remains unchanged.

### 3. Delete a Story

Deletes a story from Elasticsearch.

- **URL**: `/stories/:id`
- **Method**: `DELETE`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **URL Parameters**:
  - `id`: Story ID (required).
- **Response**:
  - **Success (200)**:

    ```json
    {
      "message": "Story deleted successfully"
    }
    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (403)**:

    ```json
    {
      "message": "You cannot delete this story"
    }
    ```

  - **Error (404)**:

    ```json
    {
      "message": "Story not found"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to delete story"
    }
    ```
- **Notes**:
  - Only the story's author (matching `userId`) can delete the story.
  - Associated likes in Redis are not automatically deleted; consider cleaning up manually if needed.

### 4. Get User's Stories

Fetches all stories created by the authenticated user.

- **URL**: `/stories/mine`
- **Method**: `GET`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **Response**:
  - **Success (200)**:

    ```json
    {
      "stories": [
        {
          "id": "string",
          "userId": "string",
          "title": "string",
          "body": "string",
          "hashtags": ["string"],
          "createdAt": "string",
          "updatedAt": "string | null"
        }
      ]
    }
    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to fetch your stories"
    }
    ```
- **Notes**:
  - Stories are sorted by `createdAt` in descending order (newest first).
  - Returns an empty array if the user has no stories.

### 5. Get All Stories (Paginated)

Fetches paginated stories for infinite scroll, accessible to all authenticated users.

- **URL**: `/stories`
- **Method**: `GET`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **Query Parameters**:
  - `limit`: Number of stories to fetch (default: 5, optional).
  - `lastTimestamp`: Timestamp of the last fetched story for pagination (optional).
- **Response**:
  - **Success (200)**:

    ```json
    {
      "stories": [
        {
          "id": "string",
          "userId": "string",
          "title": "string",
          "body": "string",
          "hashtags": ["string"],
          "createdAt": "string",
          "updatedAt": "string | null",
          "sort": "string"
        }
      ],
      "hasMore": boolean,
      "lastTimestamp": "string | null"
    }

    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to fetch stories"
    }
    ```
- **Notes**:
  - Stories are sorted by `createdAt` in descending order.
  - Use `lastTimestamp` from the response in the next request to fetch the next page.
  - `hasMore` indicates if more stories are available.
  - The `sort` field in each story is the `createdAt` timestamp used for pagination.

### 6. Like a Story

Adds a like to a story, stored in Redis.

- **URL**: `/stories/:id/like`
- **Method**: `POST`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **URL Parameters**:
  - `id`: Story ID (required).
- **Response**:
  - **Success (200)**:

    ```json
    {
      "message": "Story liked successfully"
    }
    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Error liking story"
    }
    ```
- **Notes**:
  - A user can like a story only once (Redis set ensures uniqueness).
  - The story does not need to exist in Elasticsearch for a like to be recorded.

### 7. Unlike a Story

Removes a like from a story in Redis.

- **URL**: `/stories/:id/like`
- **Method**: `DELETE`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **URL Parameters**:
  - `id`: Story ID (required).
- **Response**:
  - **Success (200)**:

    ```json
    {
      "message": "Story unliked successfully"
    }
    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Error unliking story"
    }
    ```
- **Notes**:
  - If the user has not liked the story, the operation has no effect.

### 8. Get Likes Count

Fetches the number of likes for a story from Redis.

- **URL**: `/stories/:id/likes`
- **Method**: `GET`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **URL Parameters**:
  - `id`: Story ID (required).
- **Response**:
  - **Success (200)**:

    ```json
    {
      "likesCount": number
    }

    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Error getting likes count"
    }
    ```
- **Notes**:
  - Returns `0` if no likes exist for the story.

### 9. Post a Comment

Adds a comment to a story, stored in Elasticsearch.

- **URL**: `/stories/:id/comments`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **URL Parameters**:
  - `id`: Story ID (required).
- **Request Body**:

  ```json
  {
    "body": "string"
  }
  ```

  - `body`: Comment content (required, min 1 character).

- **Response**:
  - **Success (201)**:

    ```json
    {
      "message": "Comment posted successfully",
      "comment": {
        "id": "string",
        "storyId": "string",
        "userId": "string",
        "body": "string",
        "createdAt": "string"
      }
    }
    ```

  - **Error (400)**:

    ```json
    {
      "message": "Comment body is required"
    }
    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to post comment"
    }
    ```
- **Notes**:
  - The `createdAt` field is set to the current timestamp in ISO format.
  - The `userId` is taken from the JWT, and `storyId` is from the URL parameter.

### 10. Get Comments for a Story (Paginated)

Fetches paginated comments for a specific story.

- **URL**: `/stories/:id/comments`
- **Method**: `GET`
- **URL Parameters**:
  - `id`: Story ID (required).
- **Query Parameters**:
  - `limit`: Number of comments to fetch (default: 10, optional).
  - `lastFetchedId`: Timestamp of the last fetched comment for pagination (optional).
- **Response**:
  - **Success (200)**:

    ```json
    {
      "comments": [
        {
          "id": "string",
          "storyId": "string",
          "userId": "string",
          "body": "string",
          "createdAt": "string",
          "updatedAt": "string | null"
        }
      ],
      "hasMore": boolean
    }

    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to fetch comments"
    }
    ```
- **Notes**:
  - Comments are sorted by `createdAt` in ascending order (oldest first).
  - Use `lastFetchedId` (the `createdAt` of the last comment) in the next request to fetch the next page.
  - `hasMore` indicates if more comments are available.
  - No authentication is required for this endpoint, but including a token is recommended for consistency.

### 11. Edit a Comment

Updates an existing comment in Elasticsearch.

- **URL**: `/comments/:id`
- **Method**: `PUT`
- **Content-Type**: `application/json`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **URL Parameters**:
  - `id`: Comment ID (required).
- **Request Body**:

  ```json
  {
    "body": "string"
  }
  ```

  - `body`: Updated comment content (required).

- **Response**:
  - **Success (200)**:

    ```json
    {
      "message": "Comment updated successfully",
      "comment": {
        "id": "string",
        "storyId": "string",
        "userId": "string",
        "body": "string",
        "createdAt": "string",
        "updatedAt": "string"
      }
    }
    ```

  - **Error (400)**:

    ```json
    {
      "message": "Comment body is required"
    }
    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (403)**:

    ```json
    {
      "message": "You can only edit your own comments"
    }
    ```

  - **Error (404)**:

    ```json
    {
      "message": "Comment not found"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to edit comment"
    }
    ```
- **Notes**:
  - Only the comment's author (matching `userId`) can edit the comment.
  - The `updatedAt` field is set to the current timestamp in ISO format.

### 12. Delete a Comment

Deletes a comment from Elasticsearch.

- **URL**: `/comments/:id`
- **Method**: `DELETE`
- **Headers**:
  - `Authorization`: `Bearer <token>`
- **URL Parameters**:
  - `id`: Comment ID (required).
- **Response**:
  - **Success (200)**:

    ```json
    {
      "message": "Comment deleted successfully"
    }
    ```

  - **Error (401)**:

    ```json
    {
      "message": "Unauthorized"
    }
    ```

  - **Error (403)**:

    ```json
    {
      "message": "You can only delete your own comments"
    }
    ```

  - **Error (404)**:

    ```json
    {
      "message": "Comment not found"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to delete comment"
    }
    ```
- **Notes**:
  - Only the comment's author (matching `userId`) can delete the comment.

### Get Stories by Hashtag (Paginated)

Fetches paginated stories that contain a specific hashtag, suitable for infinite scroll or paginated displays.

-   **URL**: `/stories/hashtag/:hashtag`
-   **Method**: `GET`
-   **URL Parameters**:
    -   `hashtag`: The exact hashtag to search for (required, case-sensitive, e.g., `motivation`).
-   **Query Parameters**:
    -   `limit`: Number of stories to fetch per page (optional, default: 10, max: 100 recommended).
    -   `lastFetchedCreatedAt`: ISO timestamp of the last fetched story’s `createdAt` for pagination (optional, e.g., `2025-04-28T12:00:00.000Z`).
-   **Response**:
    -   **Success (200)**:
        
        ```json
        {
          "stories": [
            {
              "id": "string",
              "userId": "string",
              "title": "string",
              "body": "string",
              "hashtags": ["string"],
              "createdAt": "string",
              "updatedAt": "string | null"
            }
          ],
          "hasMore": boolean
        }
        
        ```
        
    -   **Error (500)**:
        
        ```json
        {
          "message": "Failed to fetch stories by hashtag"
        }
        
        ```
        
-   **Notes**:
    -   Stories are sorted by `createdAt` in descending order (newest first).
    -   The `hashtag` parameter must match exactly (case-sensitive) one of the hashtags in the story’s `hashtags` array.
    -   Use `lastFetchedCreatedAt` from the `createdAt` field of the last story in the response for the next page’s request.
    -   `hasMore` indicates whether additional stories are available (true if the response contains `limit` stories).
    -   Returns an empty `stories` array if no stories match the hashtag.

## Error Handling

- **400 Bad Request**: Invalid or missing request parameters (e.g., missing `title`, `body`, `hashtags`, or `comment body`). Not explicitly handled in the endpoint, but invalid query parameters (e.g., non-numeric `limit`) may cause unexpected behavior. Ensure proper validation on the frontend.
- **401 Unauthorized**: Missing or invalid JWT token.
- **403 Forbidden**: User attempts to edit/delete a story or comment they do not own.
- **404 Not Found**: Story or comment not found in Elasticsearch.
- **500 Internal Server Error**: Server-side issues, such as Elasticsearch or Redis errors.

## Security Considerations

- **Secure Storage**: Store JWT tokens securely (e.g., in memory or HTTP-only cookies).
- **HTTPS**: Ensure all API requests are made over HTTPS to protect sensitive data.
- **Input Validation**: Validate all inputs (e.g., `title`, `body`, `hashtags`, `comment body`) on the frontend before sending to the API.
- **Rate Limiting**: Implement rate limiting on the frontend for like and comment actions to prevent abuse.
- **Token Expiry**: Ensure the JWT token is refreshed using the `/refresh-token` endpoint (from the authentication API) before it expires.

## Example Workflow (Creating and Interacting with a Story)

1.  **Create a Story**:
    - POST `/stories` with `title`, `body`, and `hashtags`.
    - Receive `storyId`.
2.  **Like the Story**:
    - POST `/stories/<storyId>/like` to add a like.
    - GET `/stories/<storyId>/likes` to check the likes count.
3.  **Post a Comment**:
    - POST `/stories/<storyId>/comments` with `body`.
    - Receive comment details.
4.  **Fetch Comments**:
    - GET `/stories/<storyId>/comments` with optional `limit` and `lastFetchedId`.
    - Receive paginated comments and `hasMore`.
5.  **Edit/Delete Story** (if author):
    - PUT `/stories/<storyId>` to update the story.
    - DELETE `/stories/<storyId>` to delete the story.
6.  **Edit/Delete Comment** (if author):
    - PUT `/comments/<commentId>` to update the comment.
    - DELETE `/comments/<commentId>` to delete the comment.

## Example Workflow (Infinite Scroll for Stories)

1.  **Initial Fetch**:
    - GET `/stories?limit=5` to fetch the first 5 stories.
    - Receive `stories`, `hasMore`, and `lastTimestamp`.
2.  **Subsequent Fetches**:
    - GET `/stories?limit=5&lastTimestamp=<lastTimestamp>` to fetch the next 5 stories.
    - Repeat until `hasMore` is `false`.

## Frontend Integration Tips

- **Form Validation**:
  - Ensure `title`, `body`, and `hashtags` are non-empty for story creation/editing.
  - Validate comment `body` is non-empty.
  - Sanitize inputs to prevent XSS attacks (e.g., strip HTML tags).
- **Error Messages**:
  - Display API error messages to users (e.g., "You cannot edit this story", "Failed to fetch comments").
  - Handle 401 errors by refreshing the token or redirecting to the login page.
- **Token Management**:
  - Include `Authorization: Bearer <token>` in all requests except `/stories/:id/comments`.
  - Automatically refresh the token using `/refresh-token` if a 401 error occurs.
- **Infinite Scroll**:
  - Store `lastTimestamp` from the `/stories` response and include it in the next request.
  - Use `hasMore` to determine when to stop fetching.
  - Implement a loading state while fetching stories.
- **Likes**:
  - Fetch `likesCount` after liking/unliking to update the UI.
  - Disable the like button if the user has already liked the story (check via Redis or UI state).
- **Comments**:
  - Implement a "Load More" button or infinite scroll for comments using `lastFetchedId`.
  - Show edit/delete options only for the user's own comments (compare `userId`).
- **UI/UX**:
  - Show a loading state for story/comment creation, liking, and fetching.
  - Provide feedback for actions (e.g., "Story liked", "Comment posted").
  - Use a modal or form for story/comment creation and editing.
  - Display hashtags as clickable tags for filtering or searching.

## Dependencies

The backend uses the following libraries:

- `express`: Web framework for Node.js.
- `elasticsearch`: Elasticsearch client for storing and querying stories and comments.
- `redis`: Redis client for storing likes.
- `uuid`: Generates unique IDs for stories.
- `verifyToken`: Custom middleware for JWT verification.

## Environment Variables

Ensure the following environment variables are configured on the backend:

- `ELASTICSEARCH_URL`: URL for the Elasticsearch instance.
- `REDIS_URL`: URL for the Redis instance.
- `JWT_SECRET`: Secret key for verifying JWT tokens (used in `verifyToken` middleware).

## Contact

For issues or questions, contact the backend team at `support@mindbloom.com`.
