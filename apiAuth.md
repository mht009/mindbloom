# API Documentation for Authentication

This document provides detailed information about the authentication-related API endpoints for the mindbloom application. It includes endpoint descriptions, request/response formats, authentication requirements, and error handling to assist frontend developers in integrating with the backend. This version reflects updates to the authentication API, incorporating Redis for OTP and token storage, username validation with Elasticsearch, and support for flexible login identifiers (username, phone, or email).

## Base URL

All API endpoints are relative to the base URL:  
`https://api.mindbloom.com`

## Authentication

- **JWT Tokens**: Most endpoints require a JSON Web Token (JWT) for authentication, provided in the `Authorization` header as `Bearer <token>`.
- **Refresh Tokens**: Used to obtain new access tokens when the current access token expires. Stored in Redis with a 7-day expiry.
- **OTP**: One-Time Passwords are used for signup and password reset verification, stored in Redis with a 5-minute expiry and a maximum of 5 verification attempts.
- **Username Validation**: Usernames are checked for uniqueness in both MySQL and Elasticsearch, with suggestions provided if a username is taken.

## Data Storage

- **MySQL**: Stores user data (name, username, email, phone, hashed password).
- **Redis**: Stores OTPs (`otp:<phone>`), access tokens (`access:<userId>`), and refresh tokens (`refresh:<userId>`).
- **Elasticsearch**: Stores user data (`users` index) for username availability checks and search functionality.

## Endpoints

### 1. Check Username Availability

Checks if a username is available and provides suggestions if it is taken.

- **URL**: `/check-username/:username`
- **Method**: `GET`
- **URL Parameters**:
  - `username`: The username to check (required, alphanumeric, underscores allowed).
- **Response**:
  - **Success (200, Available)**:

    ```json
    {
      "available": true,
      "message": "Username is available",
      "suggestions": []
    }
    ```

  - **Success (200, Taken)**:

    ```json
    {
      "available": false,
      "message": "Username is already taken",
      "suggestions": ["string", "string", "string"]
    }
    ```

  - **Error (400)**:

    ```json
    {
      "message": "Username is required"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Server error during username check"
    }
    ```
- **Notes**:
  - Checks both MySQL and Elasticsearch for username uniqueness.
  - If the username is taken, up to 3 alternative suggestions are provided (e.g., `username123`, `username_45`, `real_username`).
  - Suggestions are generated by appending random numbers, underscores, the current year, or prefixes like `real_`.
  - Use this endpoint before prompting the user to enter a username during signup.

### 2. Signup (Request OTP or Register with Email)

Initiates the signup process by sending an OTP to the user's phone (if provided) or directly registering the user if only email is used.

- **URL**: `/signup`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Request Body**:

  ```json
  {
    "name": "string",
    "username": "string",
    "email": "string | null",
    "phone": "string | null",
    "password": "string"
  }
  ```

  - `name`: User's full name (required, min 2 characters).
  - `username`: Unique username (required, alphanumeric, underscores allowed).
  - `email`: User's email address (optional, must be valid if provided).
  - `phone`: User's phone number in international format (e.g., `+1234567890`, optional but required if no email).
  - `password`: User's password (required, min 6 characters).

- **Response**:
  - **Success (200, Phone Provided)**:

    ```json
    {
      "message": "OTP sent to phone",
      "userData": {
        "name": "string",
        "username": "string",
        "email": "string | null",
        "phone": "string"
      }
    }
    ```

  - **Success (201, Email Only)**:

    ```json
    {
      "message": "User registered successfully",
      "accessToken": "string",
      "refreshToken": "string",
      "user": {
        "id": "number",
        "name": "string",
        "username": "string",
        "phone": "string | null",
        "email": "string | null"
      }
    }
    ```

  - **Error (400)**:

    ```json
    {
      "message": "Name, username, password, and either phone or email are required"
    }
    ```

    ```json
    {
      "message": "Password must be at least 6 characters"
    }
    ```

    ```json
    {
      "message": "Username is already taken"
    }
    ```

    ```json
    {
      "message": "Email is already registered"
    }
    ```

    ```json
    {
      "message": "Phone number is already registered"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to send OTP"
    }
    ```

    ```json
    {
      "message": "Server error during signup"
    }
    ```
- **Notes**:
  - At least one of `phone` or `email` must be provided.
  - If `phone` is provided, an OTP is sent via SMS (6 digits, valid for 5 minutes), and the client must proceed to `/verify-otp`.
  - If only `email` is provided, the user is registered immediately, and tokens are returned.
  - The `userData` in the OTP response should be stored client-side and sent back in the `/verify-otp` request.
  - Username, email, and phone must be unique across MySQL and Elasticsearch.

### 3. Resend OTP

Resends a new OTP to the user's phone number.

- **URL**: `/resend-otp`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Request Body**:

  ```json
  {
    "phone": "string"
  }
  ```

  - `phone`: User's phone number in international format (required).

- **Response**:
  - **Success (200)**:

    ```json
    {
      "message": "OTP resent successfully"
    }
    ```

  - **Error (400)**:

    ```json
    {
      "message": "Phone number is required"
    }
    ```

  - **Error (429)**:

    ```json
    {
      "message": "Please wait before requesting another OTP",
      "retryAfter": number
    }

    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to resend OTP"
    }
    ```

    ```json
    {
      "message": "Server error during OTP resend"
    }
    ```
- **Notes**:
  - Use this endpoint if the user did not receive the OTP or it expired.
  - Rate limiting prevents OTP resends within 1 minute of the last request (based on Redis TTL).
  - The new OTP replaces the previous one, is 6 digits, and is valid for 5 minutes.

### 4. Verify OTP (Complete Signup)

Verifies the OTP and completes the user registration process for phone-based signup.

- **URL**: `/verify-otp`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Request Body**:

  ```json
  {
    "otp": "string",
    "phone": "string",
    "name": "string",
    "username": "string",
    "email": "string | null",
    "password": "string"
  }
  ```

  - `otp`: 6-digit OTP received via SMS (required).
  - `phone`: User's phone number (required).
  - `name`: User's full name (required).
  - `username`: User's username (required).
  - `email`: User's email address (optional).
  - `password`: User's password (required, min 6 characters).

- **Response**:
  - **Success (201)**:

    ```json
    {
      "message": "User registered successfully",
      "accessToken": "string",
      "refreshToken": "string",
      "user": {
        "id": "number",
        "name": "string",
        "username": "string",
        "phone": "string",
        "email": "string | null"
      }
    }
    ```

  - **Error (400)**:

    ```json
    {
      "message": "Missing required fields"
    }
    ```

    ```json
    {
      "message": "Invalid OTP"
    }
    ```

    ```json
    {
      "message": "OTP not found or expired"
    }
    ```

    ```json
    {
      "message": "Too many failed attempts. Please request a new OTP."
    }
    ```

    ```json
    {
      "message": "Username is already taken"
    }
    ```

    ```json
    {
      "message": "Email is already registered"
    }
    ```

    ```json
    {
      "message": "Phone number is already registered"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Server error during OTP verification"
    }
    ```
- **Notes**:
  - The same `name`, `username`, `email`, `phone`, and `password` from the `/signup` request must be provided.
  - The OTP must match the one stored in Redis, not be expired, and have fewer than 5 failed attempts.
  - Upon successful verification, an access token (valid for 1 hour) and a refresh token (valid for 7 days) are stored in Redis and returned.
  - The user is indexed in Elasticsearch for username searches.
  - The OTP is removed from Redis after successful registration.

### 5. Login

Authenticates a user using username, phone, or email and returns access and refresh tokens.

- **URL**: `/login`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Request Body**:

  ```json
  {
    "username": "string | null",
    "phone": "string | null",
    "email": "string | null",
    "password": "string"
  }
  ```

  - `username`: User's username (optional, one of `username`, `phone`, or `email` required).
  - `phone`: User's phone number (optional).
  - `email`: User's email address (optional).
  - `password`: User's password (required).

- **Response**:
  - **Success (200)**:

    ```json
    {
      "accessToken": "string",
      "refreshToken": "string",
      "user": {
        "id": "number",
        "name": "string",
        "username": "string",
        "phone": "string | null",
        "email": "string | null"
      }
    }
    ```

  - **Error (400)**:

    ```json
    {
      "message": "Login identifier (username, phone, or email) and password are required"
    }
    ```

    ```json
    {
      "message": "Invalid password"
    }
    ```

  - **Error (404)**:

    ```json
    {
      "message": "User not found"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Server error during login"
    }
    ```
- **Notes**:
  - At least one of `username`, `phone`, or `email` must be provided.
  - The `accessToken` is valid for 1 hour and stored in Redis.
  - The `refreshToken` is valid for 7 days and stored in Redis.
  - Use the `accessToken` in the `Authorization` header for authenticated requests.

### 6. Refresh Token

Obtains a new access token using a refresh token.

- **URL**: `/refresh-token`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Request Body**:

  ```json
  {
    "refreshToken": "string"
  }
  ```

  - `refreshToken`: Refresh token received during login or signup (required).

- **Response**:
  - **Success (200)**:

    ```json
    {
      "accessToken": "string"
    }
    ```

  - **Error (401)**:

    ```json
    {
      "message": "Refresh Token required"
    }
    ```

  - **Error (403)**:

    ```json
    {
      "message": "Invalid Refresh Token"
    }
    ```

    ```json
    {
      "message": "Refresh Token not recognized or expired"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Server error during token refresh"
    }
    ```
- **Notes**:
  - The new `accessToken` is valid for 1 hour and stored in Redis.
  - The `refreshToken` must be valid and match the one stored in Redis.
  - If the refresh token is invalid or expired, the user must log in again.

### 7. Logout

Invalidates the user's access and refresh tokens.

- **URL**: `/logout`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Request Body**:

  ```json
  {
    "userId": "number"
  }
  ```

  - `userId`: The ID of the user to log out (required).

- **Response**:
  - **Success (200)**:

    ```json
    {
      "message": "Logged out successfully"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Server error during logout"
    }
    ```
- **Notes**:
  - Removes both access and refresh tokens from Redis for the specified `userId`.
  - If no tokens exist for the `userId`, the endpoint still returns a success response.
  - Typically called when the user explicitly logs out.

### 8. Request Password Reset (Request OTP)

Initiates the password reset process by sending an OTP to the user's phone.

- **URL**: `/reset-password/request`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Request Body**:

  ```json
  {
    "phone": "string"
  }
  ```

  - `phone`: User's phone number (required).

- **Response**:
  - **Success (200)**:

    ```json
    {
      "message": "OTP sent to phone"
    }
    ```

  - **Error (400)**:

    ```json
    {
      "message": "Phone number is required"
    }
    ```

  - **Error (404)**:

    ```json
    {
      "message": "User not found"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Failed to send OTP"
    }
    ```

    ```json
    {
      "message": "Server error during password reset request"
    }
    ```
- **Notes**:
  - The phone number must be associated with a registered user.
  - The OTP is 6 digits, stored in Redis, and valid for 5 minutes.

### 9. Verify OTP and Reset Password

Verifies the OTP and updates the user's password.

- **URL**: `/reset-password/verify`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Request Body**:

  ```json
  {
    "otp": "string",
    "phone": "string",
    "newPassword": "string"
  }
  ```

  - `otp`: 6-digit OTP received via SMS (required).
  - `phone`: User's phone number (required).
  - `newPassword`: New password (required, min 6 characters).

- **Response**:
  - **Success (200)**:

    ```json
    {
      "message": "Password reset successfully"
    }
    ```

  - **Error (400)**:

    ```json
    {
      "message": "OTP, phone and new password are required"
    }
    ```

    ```json
    {
      "message": "Password must be at least 6 characters"
    }
    ```

    ```json
    {
      "message": "Invalid OTP"
    }
    ```

    ```json
    {
      "message": "OTP not found or expired"
    }
    ```

    ```json
    {
      "message": "Too many failed attempts. Please request a new OTP."
    }
    ```

  - **Error (404)**:

    ```json
    {
      "message": "User not found"
    }
    ```

  - **Error (500)**:

    ```json
    {
      "message": "Server error during password reset verification"
    }
    ```
- **Notes**:
  - The OTP must match the one stored in Redis, not be expired, and have fewer than 5 failed attempts.
  - The OTP is removed from Redis after a successful password reset.
  - All access and refresh tokens for the user are invalidated upon successful password reset.
  - The user must log in with the new password after reset.

## Error Handling

- **400 Bad Request**: Invalid or missing request parameters, or validation errors (e.g., invalid OTP, username taken, password too short).
- **401 Unauthorized**: Missing or invalid refresh token.
- **403 Forbidden**: Invalid or unrecognized refresh token.
- **404 Not Found**: User not found for the provided username, phone, or email.
- **429 Too Many Requests**: OTP resend requested too soon (within 1 minute).
- **500 Internal Server Error**: Server-side issues, such as Redis, Elasticsearch, Twilio, or database errors.

## Security Considerations

- **Secure Storage**:
  - Store `accessToken` and `refreshToken` securely (e.g., `refreshToken` in HTTP-only cookies).
  - Store `userData` from `/signup` temporarily client-side for `/verify-otp`.
- **HTTPS**: Ensure all API requests are made over HTTPS to protect sensitive data.
- **Input Validation**:
  - Validate phone numbers (international format, e.g., `+1234567890`).
  - Validate usernames (alphanumeric, underscores, reasonable length).
  - Ensure passwords are at least 6 characters.
  - Validate email format if provided.
- **Rate Limiting**:
  - OTP resends are limited to once per minute (enforced by Redis TTL).
  - OTP verification allows up to 5 attempts before requiring a new OTP.
  - In production, implement proper rate limiting middleware for all endpoints.
- **Token Expiry**:
  - Access tokens expire after 1 hour (Redis TTL: 3600 seconds).
  - Refresh tokens expire after 7 days (Redis TTL: 604800 seconds).
  - OTPs expire after 5 minutes (Redis TTL: 300 seconds).
- **OTP Security**:
  - OTPs are numeric (6 digits) for SMS compatibility.
  - Failed OTP attempts are tracked in Redis, with a lockout after 5 attempts.
  - OTPs are automatically removed after expiry or successful use.
- **Elasticsearch**:
  - User data is indexed in the `users` index with immediate refresh for search consistency.
  - Fallback to MySQL if Elasticsearch fails during username checks.

## Example Workflow (Signup with Phone)

1.  **Check Username**:
    - GET `/check-username/cooluser`
    - If taken, display `suggestions` (e.g., `cooluser123`, `real_cooluser`).
2.  **Request OTP**:
    - POST `/signup` with `name`, `username`, `email`, `phone`, and `password`.
    - Receive `userData` and store it client-side; OTP is sent via SMS.
3.  **Resend OTP (if needed)**:
    - POST `/resend-otp` with `phone` if OTP is not received or expired (wait 1 minute).
4.  **Verify OTP**:
    - POST `/verify-otp` with `otp` and `userData` (`name`, `username`, `email`, `phone`, `password`).
    - Receive `accessToken`, `refreshToken`, and user details.
5.  **Use Token**:
    - Include `Bearer <accessToken>` in the `Authorization` header for authenticated requests.

## Example Workflow (Signup with Email Only)

1.  **Check Username**:
    - GET `/check-username/cooluser`
    - If taken, display `suggestions`.
2.  **Register**:
    - POST `/signup` with `name`, `username`, `email`, and `password` (no `phone`).
    - Receive `accessToken`, `refreshToken`, and user details.
3.  **Use Token**:
    - Include `Bearer <accessToken>` in the `Authorization` header.

## Example Workflow (Login)

1.  **Login**:
    - POST `/login` with `username`, `phone`, or `email` and `password`.
    - Receive `accessToken`, `refreshToken`, and user details.
2.  **Refresh Token (if access token expires)**:
    - POST `/refresh-token` with `refreshToken`.
    - Receive new `accessToken`.
3.  **Logout**:
    - POST `/logout` with `userId`.
    - Tokens are invalidated in Redis.

## Example Workflow (Password Reset)

1.  **Request OTP**:
    - POST `/reset-password/request` with `phone`.
    - Receive OTP via SMS.
2.  **Verify OTP and Reset**:
    - POST `/reset-password/verify` with `otp`, `phone`, and `newPassword`.
    - Password is updated, tokens are invalidated, and user can log in with the new password.

## Frontend Integration Tips

- **Form Validation**:
  - Validate phone numbers (international format, e.g., `+1234567890`).
  - Validate usernames (alphanumeric, underscores, max 20 characters recommended).
  - Ensure passwords are at least 6 characters.
  - Validate email format if provided.
  - Sanitize inputs to prevent injection attacks.
- **Username Handling**:
  - Check username availability in real-time using `/check-username/:username` as the user types.
  - Display suggestions if the username is taken (e.g., “Try: cooluser123, real_cooluser”).
- **Error Messages**:
  - Display specific error messages (e.g., “Username is already taken”, “Too many failed attempts”).
  - For 429 errors, show `retryAfter` seconds in a countdown timer.
  - Handle OTP expiry or too many attempts by prompting the user to resend OTP.
- **Token Management**:
  - Store `accessToken` in memory or local storage (short-lived).
  - Store `refreshToken` in HTTP-only cookies for security.
  - Automatically refresh the access token before it expires using `/refresh-token`.
  - Clear tokens and redirect to login page after calling `/logout`.
- **UI/UX**:
  - Show a loading state while waiting for OTP or API responses.
  - Provide a “Resend OTP” button with a 60-second countdown timer based on rate limiting.
  - After successful signup or password reset, redirect to the login page or dashboard.
  - Display OTP attempt limits (e.g., “3 attempts remaining”) to guide users.
  - Show username suggestions in a dropdown or list during signup.
- **Rate Limiting**:
  - Disable the “Resend OTP” button until `retryAfter` seconds have passed.
  - Warn users about the 5-attempt limit for OTP verification.

## Dependencies

The backend uses the following libraries:

- `express`: Web framework for Node.js.
- `bcryptjs`: Password hashing.
- `jsonwebtoken`: JWT generation and verification.
- `twilio`: SMS OTP delivery.
- `sequelize`: MySQL ORM for database operations.
- `otp-generator`: OTP generation.
- `@elastic/elasticsearch`: Elasticsearch client for username searches.
- `redis`: Redis client for OTP and token storage.

## Environment Variables

Ensure the following environment variables are configured on the backend:

- `TWILIO_ACCOUNT_SID`: Twilio account SID.
- `TWILIO_AUTH_TOKEN`: Twilio auth token.
- `TWILIO_PHONE_NUMBER`: Twilio phone number for sending SMS.
- `JWT_SECRET`: Secret key for signing access tokens.
- `JWT_REFRESH_SECRET`: Secret key for signing refresh tokens.
- `ELASTICSEARCH_NODE`: Elasticsearch node URL (default: `http://localhost:9200`).
- `REDIS_URL`: Redis connection URL.

## Contact

For issues or questions, contact the backend team at `support@mindbloom.com`.
